<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ° å¹¸é‹æŠ½çæ©Ÿ Lucky Draw Machine</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow-x:hidden}
body{
  background:linear-gradient(135deg,#0F0C29 0%,#1A1A2E 40%,#16213E 100%);
  font-family:'Noto Sans TC','Segoe UI',sans-serif;
  color:#E8E8E8;
  min-height:100vh;
}
/* Stars */
.star{position:fixed;border-radius:50%;background:#fff;pointer-events:none;z-index:0}
@keyframes twinkle{0%,100%{opacity:.15}50%{opacity:.7}}
/* Common */
.container{max-width:820px;margin:0 auto;padding:30px 20px;position:relative;z-index:1}
.card{background:rgba(255,255,255,.04);backdrop-filter:blur(20px);border-radius:20px;border:1px solid rgba(255,255,255,.08);padding:28px;margin-bottom:20px}
.gradient-text{
  font-weight:900;
  background:linear-gradient(135deg,#F8C471,#F39C12,#E74C3C,#FF6B6B);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  letter-spacing:6px;
}
/* Buttons */
.btn-primary{background:linear-gradient(135deg,#F39C12,#E74C3C);color:#fff;border:none;border-radius:12px;padding:14px 36px;font-size:17px;font-weight:700;cursor:pointer;letter-spacing:2px;box-shadow:0 4px 20px rgba(243,156,18,.3);font-family:inherit;transition:all .2s}
.btn-primary:hover{transform:scale(1.03);box-shadow:0 6px 30px rgba(243,156,18,.5)}
.btn-draw{background:linear-gradient(135deg,#F39C12,#E74C3C);color:#fff;border:none;border-radius:16px;padding:18px 56px;font-size:22px;font-weight:900;cursor:pointer;letter-spacing:3px;box-shadow:0 6px 30px rgba(243,156,18,.4);font-family:inherit;transition:all .2s}
.btn-draw:hover:not(:disabled){transform:scale(1.04);box-shadow:0 8px 40px rgba(243,156,18,.6)}
.btn-draw:disabled{opacity:.4;cursor:not-allowed}
.btn-secondary{background:rgba(255,255,255,.08);color:#E8E8E8;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px 24px;font-size:14px;cursor:pointer;font-family:inherit;transition:all .2s}
.btn-secondary:hover{background:rgba(255,255,255,.14)}
.btn-file{background:rgba(78,205,196,.15);color:#4ECDC4;border:1px solid rgba(78,205,196,.3);border-radius:10px;padding:10px 20px;font-size:14px;cursor:pointer;font-family:inherit}
.btn-sound{position:fixed;top:16px;right:16px;z-index:100;border-radius:50%;width:48px;height:48px;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;backdrop-filter:blur(10px);border:1px solid;transition:all .3s}
.btn-sound.on{background:rgba(78,205,196,.2);color:#4ECDC4;border-color:rgba(78,205,196,.4)}
.btn-sound.off{background:rgba(255,255,255,.08);color:#7F8C8D;border-color:rgba(255,255,255,.1)}
/* Import */
.import-card{background:rgba(255,255,255,.05);backdrop-filter:blur(20px);border-radius:24px;border:1px solid rgba(255,255,255,.1);padding:36px}
textarea{width:100%;min-height:180px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.12);border-radius:12px;color:#E8E8E8;padding:16px;font-size:15px;font-family:'Noto Sans TC',monospace;resize:vertical;outline:none;line-height:1.8}
.number-input{width:70px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.15);border-radius:8px;color:#F8C471;padding:8px 12px;font-size:18px;text-align:center;font-weight:700;outline:none}
/* Chips */
.chip{display:inline-block;margin:4px;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:500;transition:all .3s}
.chip-active{background:rgba(78,205,196,.15);color:#4ECDC4;border:1px solid rgba(78,205,196,.2)}
.chip-won{background:rgba(243,156,18,.15);color:#F8C471;border:1px solid rgba(243,156,18,.25);text-decoration:line-through;opacity:.6}
/* Winner */
.winner-badge{display:inline-block;margin:6px;padding:10px 24px;background:linear-gradient(135deg,#FFD700,#FFA500);color:#1A1A2E;border-radius:30px;font-weight:900;font-size:22px;box-shadow:0 4px 20px rgba(255,215,0,.4);animation:scaleIn .5s ease-out}
.history-item{display:flex;align-items:center;gap:12px;padding:10px 16px;background:rgba(255,215,0,.05);border-radius:10px;margin-bottom:8px;border:1px solid rgba(255,215,0,.1);animation:slideUp .4s ease-out both}
.history-round{background:linear-gradient(135deg,#F39C12,#E74C3C);color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0}
.history-name{background:rgba(255,215,0,.12);color:#FFD700;padding:4px 12px;border-radius:16px;font-size:14px;font-weight:600;display:inline-block;margin:2px}
/* Confetti */
.confetti{position:fixed;top:-20px;border-radius:2px;pointer-events:none;z-index:9999}
/* Rolling text */
.rolling-text{font-size:42px;font-weight:900;color:#F8C471;text-shadow:0 0 30px rgba(248,196,113,.5);letter-spacing:4px;text-align:center;margin-top:-10px}
/* Animations */
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}
@keyframes scaleIn{0%{transform:scale(0);opacity:0}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes glow{0%,100%{filter:drop-shadow(0 0 15px rgba(255,200,50,.3))}50%{filter:drop-shadow(0 0 35px rgba(255,200,50,.7))}}
@keyframes drumShake{0%,100%{transform:rotate(0)}25%{transform:rotate(-1deg)}75%{transform:rotate(1deg)}}
@keyframes confettiFall{0%{top:-20px;opacity:1;transform:rotate(0) translateX(0)}100%{top:110vh;opacity:0;transform:rotate(720deg) translateX(80px)}}
@keyframes ejectBall{0%{transform:translate(0,0) scale(1);opacity:1}30%{transform:translate(80px,-60px) scale(1.3);opacity:1}100%{transform:translate(160px,-120px) scale(1.8);opacity:0}}
.box-glow{animation:glow .8s ease-in-out infinite}
.drum-shake{animation:drumShake .15s infinite}
.animate-pulse{animation:pulse .15s infinite}
.animate-float{animation:float 3s ease-in-out infinite}
</style>
</head>
<body>

<!-- Sound Toggle -->
<button class="btn-sound on" id="soundBtn" onclick="toggleSound()">ğŸ”Š</button>

<!-- Stars -->
<div id="starField"></div>

<!-- Confetti container -->
<div id="confettiContainer"></div>

<!-- ===== IMPORT SCREEN ===== -->
<div id="importScreen" class="container">
  <div style="text-align:center;margin-bottom:30px">
    <div style="font-size:64px;margin-bottom:12px">ğŸ°</div>
    <h1 class="gradient-text" style="font-size:48px;margin-bottom:8px">å¹¸é‹æŠ½çæ©Ÿ</h1>
    <p style="font-size:15px;color:#7F8C8D;letter-spacing:4px;text-transform:uppercase">Lucky Draw Machine</p>
  </div>
  <div class="import-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px">
      <h2 style="font-size:20px;font-weight:700;color:#F8C471;margin:0">ğŸ“‹ åŒ¯å…¥åƒåŠ è€…åå–®</h2>
      <div>
        <input type="file" id="fileInput" accept=".csv,.txt,.tsv" style="display:none" onchange="handleFileUpload(event)">
        <button class="btn-file" onclick="document.getElementById('fileInput').click()">ğŸ“ åŒ¯å…¥æª”æ¡ˆ (.csv/.txt)</button>
      </div>
    </div>
    <p style="color:#7F8C8D;font-size:13px;margin-bottom:16px">æ¯è¡Œä¸€å€‹åå­—ï¼Œæˆ–ç”¨é€—è™Ÿåˆ†éš”ã€‚ä¹Ÿå¯ä»¥åŒ¯å…¥ CSV / TXT æª”æ¡ˆã€‚</p>
    <textarea id="nameInput" placeholder="è¼¸å…¥åƒåŠ è€…åå–®...">ç‹å°æ˜
æå¤§è¯
å¼µç¾ç²
é™³å¿—å¼·
æ—æ·‘èŠ¬
é»ƒå»ºåœ‹
å³ä½³è“‰
è¶™æ–‡å‚‘
å‘¨é›…å©·
é„­åœ‹è±ª
è¨±å¿ƒæ€¡
è”¡æ˜è¼
æ¥Šéº—ç 
è¬å®—ç¿°
è•­é›¨è±</textarea>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:20px">
      <span id="participantCount" style="color:#7F8C8D;font-size:13px">15 ä½åƒåŠ è€…</span>
      <button class="btn-primary" onclick="startGame()">ğŸ¯ é–‹å§‹æŠ½ç</button>
    </div>
  </div>
</div>

<!-- ===== GAME SCREEN ===== -->
<div id="gameScreen" class="container" style="display:none">
  <div style="text-align:center;margin-bottom:20px">
    <h1 class="gradient-text" style="font-size:32px">ğŸ° å¹¸é‹æŠ½çæ©Ÿ</h1>
    <p id="statsLine" style="color:#7F8C8D;font-size:13px;margin-top:4px"></p>
  </div>

  <!-- Lottery Box Card -->
  <div class="card" id="boxCard" style="padding-bottom:16px">
    <div style="display:flex;justify-content:center;align-items:center;flex-direction:column;position:relative" id="boxContainer">
      <!-- Ejected Ball -->
      <div id="ejectedBall" style="display:none;position:absolute;top:80px;left:50%;margin-left:40px;z-index:20;animation:ejectBall 1.2s ease-out forwards;pointer-events:none">
        <div id="ejectedBallInner" style="width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.5)"></div>
      </div>

      <!-- SVG Box -->
      <svg id="drumSvg" width="340" height="300" viewBox="0 0 340 300">
        <defs>
          <linearGradient id="boxGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#3a3a5c"/><stop offset="100%" stop-color="#1a1a2e"/></linearGradient>
          <linearGradient id="drumGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="rgba(255,255,255,0.12)"/><stop offset="50%" stop-color="rgba(255,255,255,0.04)"/><stop offset="100%" stop-color="rgba(255,255,255,0.08)"/></linearGradient>
          <linearGradient id="goldGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#FFD700"/><stop offset="50%" stop-color="#FFA500"/><stop offset="100%" stop-color="#FF8C00"/></linearGradient>
          <radialGradient id="glassGrad" cx="0.3" cy="0.3" r="0.7"><stop offset="0%" stop-color="rgba(255,255,255,0.15)"/><stop offset="100%" stop-color="rgba(255,255,255,0.02)"/></radialGradient>
          <clipPath id="drumClip"><ellipse cx="160" cy="130" rx="118" ry="88"/></clipPath>
        </defs>
        <!-- Base -->
        <rect x="80" y="240" width="180" height="16" rx="8" fill="url(#goldGrad)" opacity=".9"/>
        <rect x="100" y="252" width="140" height="10" rx="5" fill="#B8860B" opacity=".6"/>
        <rect x="110" y="218" width="12" height="28" rx="4" fill="url(#goldGrad)" opacity=".8"/>
        <rect x="218" y="218" width="12" height="28" rx="4" fill="url(#goldGrad)" opacity=".8"/>
        <!-- Stand frame -->
        <line x1="44" y1="148" x2="116" y2="240" stroke="url(#goldGrad)" stroke-width="6" stroke-linecap="round" opacity=".8"/>
        <line x1="296" y1="148" x2="224" y2="240" stroke="url(#goldGrad)" stroke-width="6" stroke-linecap="round" opacity=".8"/>
        <!-- Axle holders -->
        <rect x="24" y="115" width="20" height="34" rx="6" fill="url(#goldGrad)" opacity=".85"/>
        <rect x="296" y="115" width="20" height="34" rx="6" fill="url(#goldGrad)" opacity=".85"/>
        <!-- Drum -->
        <ellipse cx="160" cy="130" rx="122" ry="92" fill="none" stroke="url(#goldGrad)" stroke-width="3" opacity=".6"/>
        <ellipse cx="160" cy="130" rx="118" ry="88" fill="url(#drumGrad)" stroke="rgba(255,255,255,0.15)" stroke-width="1.5"/>
        <ellipse cx="160" cy="130" rx="118" ry="88" fill="url(#glassGrad)"/>
        <!-- Cage lines -->
        <ellipse cx="160" cy="130" rx="118" ry="88" fill="none" stroke="rgba(255,215,0,0.12)" stroke-width=".8" transform="scale(0.2,1)" transform-origin="160 130"/>
        <ellipse cx="160" cy="130" rx="118" ry="88" fill="none" stroke="rgba(255,215,0,0.12)" stroke-width=".8" transform="scale(0.5,1)" transform-origin="160 130"/>
        <ellipse cx="160" cy="130" rx="118" ry="88" fill="none" stroke="rgba(255,215,0,0.12)" stroke-width=".8" transform="scale(0.75,1)" transform-origin="160 130"/>
        <line x1="42" y1="100" x2="278" y2="100" stroke="rgba(255,215,0,0.08)" stroke-width=".5"/>
        <line x1="42" y1="120" x2="278" y2="120" stroke="rgba(255,215,0,0.08)" stroke-width=".5"/>
        <line x1="42" y1="140" x2="278" y2="140" stroke="rgba(255,215,0,0.08)" stroke-width=".5"/>
        <line x1="42" y1="160" x2="278" y2="160" stroke="rgba(255,215,0,0.08)" stroke-width=".5"/>
        <!-- Balls container -->
        <g id="ballsGroup" clip-path="url(#drumClip)"></g>
        <!-- Drum border -->
        <ellipse cx="160" cy="130" rx="120" ry="90" fill="none" stroke="url(#goldGrad)" stroke-width="2.5" opacity=".5"/>
        <!-- Exit chute -->
        <path d="M265 155 Q290 155 300 180 L310 210 Q312 220 304 222 L280 222 Q272 220 274 210 L278 185 Q280 170 268 165 Z" fill="url(#boxGrad)" stroke="url(#goldGrad)" stroke-width="1.5" opacity=".9"/>
        <circle cx="292" cy="200" r="14" fill="rgba(0,0,0,0.3)" stroke="url(#goldGrad)" stroke-width="1"/>
        <!-- Crank -->
        <g id="crankGroup" transform-origin="34 132">
          <line x1="34" y1="132" x2="0" y2="132" stroke="url(#goldGrad)" stroke-width="4" stroke-linecap="round"/>
          <circle cx="0" cy="132" r="8" fill="url(#goldGrad)" stroke="#B8860B" stroke-width="1.5"/>
          <circle cx="0" cy="132" r="3" fill="#FFF8DC"/>
        </g>
        <circle cx="34" cy="132" r="6" fill="url(#goldGrad)" stroke="#B8860B" stroke-width="1.5"/>
        <circle cx="306" cy="132" r="6" fill="url(#goldGrad)" stroke="#B8860B" stroke-width="1.5"/>
        <!-- Label -->
        <rect x="110" y="56" width="100" height="24" rx="6" fill="rgba(0,0,0,0.4)" stroke="url(#goldGrad)" stroke-width="1"/>
        <text x="160" y="72" text-anchor="middle" fill="#FFD700" font-size="11" font-weight="700" font-family="Orbitron,sans-serif">LUCKY DRAW</text>
      </svg>
    </div>

    <!-- Rolling Name -->
    <div id="rollingNameDisplay" class="rolling-text" style="display:none"></div>

    <!-- Status Messages -->
    <div id="idleMsg" style="text-align:center;color:#7F8C8D;font-size:16px;margin-top:4px" class="animate-float">âœ¨ è½‰å‹•æŠ½çç®±ä¾†æŠ½ç âœ¨</div>
    <div id="winnerDisplay" style="text-align:center;margin-top:12px;display:none">
      <div style="font-size:14px;color:#F39C12;margin-bottom:12px;letter-spacing:3px">ğŸ† æ­å–œä¸­ç ğŸ†</div>
      <div id="winnerBadges" style="display:flex;flex-wrap:wrap;justify-content:center;gap:8px"></div>
    </div>

    <!-- Controls -->
    <div style="display:flex;justify-content:center;align-items:center;gap:16px;flex-wrap:wrap;margin-top:16px">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="color:#7F8C8D;font-size:14px">æ¯æ¬¡æŠ½</span>
        <input type="number" id="drawCountInput" class="number-input" value="1" min="1" onchange="updateDrawCount()">
        <span style="color:#7F8C8D;font-size:14px">ä½</span>
      </div>
      <button class="btn-draw" id="drawBtn" onclick="draw()">ğŸ² é–‹å§‹æŠ½çï¼</button>
    </div>
    <div style="display:flex;justify-content:center;gap:10px;margin-top:12px">
      <button class="btn-secondary" onclick="resetDraw()">ğŸ”„ é‡æ–°æŠ½ç</button>
      <button class="btn-secondary" onclick="goBack()">ğŸ“‹ é‡æ–°åŒ¯å…¥</button>
    </div>
  </div>

  <!-- Winner History -->
  <div class="card" id="historyCard" style="display:none">
    <h3 style="font-size:17px;font-weight:700;color:#FFD700;margin-bottom:16px">ğŸ† ä¸­çåå–®</h3>
    <div id="historyList"></div>
  </div>

  <!-- Participants -->
  <div class="card">
    <h3 id="participantsTitle" style="font-size:17px;font-weight:700;color:#4ECDC4;margin-bottom:16px"></h3>
    <div id="participantChips" style="display:flex;flex-wrap:wrap;gap:4px"></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   State
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BALL_COLORS=["#FF6B6B","#4ECDC4","#45B7D1","#FFEAA7","#DDA0DD","#F7DC6F","#BB8FCE","#85C1E9","#F8C471","#82E0AA","#F1948A","#AED6F1","#A3E4D7","#FAD7A0","#D7BDE2","#FF9FF3","#54A0FF","#5F27CD","#01A3A4","#F368E0"];
let participants=[], winners=[], currentWinner=null, drawCount=1;
let isDrawing=false, phase="idle"; // idle|spinning|slowing|eject|reveal
let soundOn=true, soundReady=false;
let crankAngle=0, crankFrame=null;
let balls=[], ballFrame=null;
let timers=[];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Sound Engine
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const sfx={ok:false};
async function initSound(){
  if(sfx.ok) return;
  await Tone.start();
  sfx.tick=new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:.001,decay:.06,sustain:0,release:.02},volume:-12}).toDestination();
  sfx.win=new Tone.PolySynth(Tone.Synth,{oscillator:{type:"sine"},envelope:{attack:.01,decay:.3,sustain:.2,release:.8},volume:-8}).toDestination();
  sfx.fan=new Tone.Synth({oscillator:{type:"square"},envelope:{attack:.01,decay:.15,sustain:.1,release:.3},volume:-14}).toDestination();
  sfx.noi=new Tone.NoiseSynth({noise:{type:"white"},envelope:{attack:.005,decay:.08,sustain:0,release:.03},volume:-20}).toDestination();
  sfx.drum=new Tone.MembraneSynth({pitchDecay:.05,octaves:4,envelope:{attack:.001,decay:.2,sustain:0,release:.2},volume:-10}).toDestination();
  sfx.tumble=new Tone.NoiseSynth({noise:{type:"pink"},envelope:{attack:.01,decay:.15,sustain:.05,release:.1},volume:-18}).toDestination();
  sfx.ok=true; soundReady=true;
}
function playTick(p){if(!sfx.ok||!soundOn)return;sfx.tick.triggerAttackRelease(Tone.Frequency(60+Math.floor(p*12),"midi").toFrequency(),"32n")}
function playSlowTick(){if(!sfx.ok||!soundOn)return;sfx.drum.triggerAttackRelease("G2","16n")}
function playTumble(){if(!sfx.ok||!soundOn)return;sfx.tumble.triggerAttackRelease("16n");sfx.drum.triggerAttackRelease("E1","32n")}
function playEject(){if(!sfx.ok||!soundOn)return;const n=Tone.now();sfx.drum.triggerAttackRelease("C2","8n",n);sfx.noi.triggerAttackRelease("8n",n);["G5","B5","D6"].forEach((no,i)=>sfx.fan.triggerAttackRelease(no,"16n",n+i*.06))}
function playWin(){if(!sfx.ok||!soundOn)return;const n=Tone.now();sfx.drum.triggerAttackRelease("C2","8n",n);["C5","E5","G5","C6"].forEach((no,i)=>sfx.fan.triggerAttackRelease(no,"8n",n+i*.1));sfx.noi.triggerAttackRelease("16n",n+.05)}
function playCelebration(){if(!sfx.ok||!soundOn)return;const n=Tone.now();[["C4","E4","G4"],["F4","A4","C5"],["G4","B4","D5"],["C4","E4","G4","C5"]].forEach((c,i)=>sfx.win.triggerAttackRelease(c,"4n",n+i*.35));for(let i=0;i<6;i++)sfx.noi.triggerAttackRelease("32n",n+.5+i*.15)}
function playClick(){if(!sfx.ok||!soundOn)return;sfx.tick.triggerAttackRelease("A5","32n")}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Stars
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function createStars(){
  const c=document.getElementById('starField');
  for(let i=0;i<40;i++){
    const d=document.createElement('div');d.className='star';
    const s=1+Math.random()*2;
    Object.assign(d.style,{left:Math.random()*100+'%',top:Math.random()*100+'%',width:s+'px',height:s+'px',animation:`twinkle ${2+Math.random()*3}s ${Math.random()*3}s infinite`});
    c.appendChild(d);
  }
}
createStars();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ball Physics
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initBalls(count){
  const cx=160,cy=130,rx=120,ry=90;
  balls=[];
  const n=Math.min(count,30);
  for(let i=0;i<n;i++){
    balls.push({x:cx+(Math.random()-.5)*rx*1.4,y:cy+(Math.random()-.5)*ry*1.2,vx:(Math.random()-.5)*3,vy:(Math.random()-.5)*3,r:16+Math.random()*4,color:BALL_COLORS[i%BALL_COLORS.length],id:i});
  }
  renderBalls();
  startBallPhysics();
}

function startBallPhysics(){
  if(ballFrame) cancelAnimationFrame(ballFrame);
  const cx=160,cy=130,rx=115,ry=85;
  function step(){
    const spinning=phase==="spinning"||phase==="slowing";
    const speed=spinning?1.8:.3;
    const gravity=spinning?.15:.4;
    balls.forEach(b=>{
      if(spinning){const a=Math.atan2(b.y-cy,b.x-cx);b.vx+=Math.cos(a+Math.PI/2)*.8*speed;b.vy+=Math.sin(a+Math.PI/2)*.8*speed;}
      b.vy+=gravity;b.vx*=.97;b.vy*=.97;b.x+=b.vx*speed;b.y+=b.vy*speed;
      const dx=(b.x-cx)/rx,dy=(b.y-cy)/ry,dist=Math.sqrt(dx*dx+dy*dy);
      if(dist>.85){const nx=dx/dist,ny=dy/dist;b.x=cx+nx*.85*rx;b.y=cy+ny*.85*ry;const dot=b.vx*nx*rx+b.vy*ny*ry;b.vx-=1.5*dot*nx/rx;b.vy-=1.5*dot*ny/ry;b.vx+=(Math.random()-.5)*2;b.vy+=(Math.random()-.5)*2;}
      for(let j=balls.indexOf(b)+1;j<balls.length;j++){const o=balls[j],ddx=b.x-o.x,ddy=b.y-o.y,d=Math.sqrt(ddx*ddx+ddy*ddy),minD=b.r+o.r-8;if(d<minD&&d>0){const ux=ddx/d,uy=ddy/d,ov=(minD-d)/2;b.x+=ux*ov;b.y+=uy*ov;o.x-=ux*ov;o.y-=uy*ov;const dv=(b.vx-o.vx)*ux+(b.vy-o.vy)*uy;b.vx-=dv*ux*.5;b.vy-=dv*uy*.5;o.vx+=dv*ux*.5;o.vy+=dv*uy*.5;}}
    });
    renderBalls();
    ballFrame=requestAnimationFrame(step);
  }
  ballFrame=requestAnimationFrame(step);
}

function renderBalls(){
  const g=document.getElementById('ballsGroup');
  if(!g) return;
  let html='';
  balls.forEach(b=>{
    html+=`<circle cx="${b.x}" cy="${b.y}" r="${b.r-2}" fill="${b.color}" opacity=".9"/>`;
    html+=`<circle cx="${b.x-3}" cy="${b.y-4}" r="${b.r*.32}" fill="rgba(255,255,255,0.45)"/>`;
  });
  g.innerHTML=html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Crank Animation
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startCrank(){
  if(crankFrame) cancelAnimationFrame(crankFrame);
  function spin(){
    const speed=phase==="spinning"?8:phase==="slowing"?3:0;
    if(speed===0){cancelAnimationFrame(crankFrame);crankFrame=null;return;}
    crankAngle+=speed;
    document.getElementById('crankGroup').setAttribute('transform',`rotate(${crankAngle},34,132)`);
    crankFrame=requestAnimationFrame(spin);
  }
  crankFrame=requestAnimationFrame(spin);
}
function stopCrank(){if(crankFrame){cancelAnimationFrame(crankFrame);crankFrame=null;}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Confetti
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showConfetti(){
  const c=document.getElementById('confettiContainer');c.innerHTML='';
  for(let i=0;i<60;i++){
    const d=document.createElement('div');d.className='confetti';
    const s=6+Math.random()*8;
    Object.assign(d.style,{left:Math.random()*100+'%',width:s+'px',height:s*.6+'px',background:BALL_COLORS[i%BALL_COLORS.length],transform:`rotate(${Math.random()*360}deg)`,animation:`confettiFall ${1.5+Math.random()*2}s ${Math.random()*.5}s ease-in forwards`});
    c.appendChild(d);
  }
  setTimeout(()=>c.innerHTML='',3500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI Updates
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getRemaining(){return participants.filter(p=>!winners.includes(p));}

function updateStats(){
  const rem=getRemaining();
  document.getElementById('statsLine').textContent=`å…± ${participants.length} äºº ï½œ å·²æŠ½ ${winners.length} äºº ï½œ å‰©é¤˜ ${rem.length} äºº`;
  document.getElementById('participantsTitle').textContent=`ğŸ‘¥ åƒåŠ è€…ï¼ˆ${rem.length} / ${participants.length}ï¼‰`;
  document.getElementById('drawCountInput').max=rem.length||1;
}

function renderChips(){
  const c=document.getElementById('participantChips');
  c.innerHTML=participants.map(p=>`<span class="chip ${winners.includes(p)?'chip-won':'chip-active'}">${p}</span>`).join('');
}

function renderHistory(){
  const card=document.getElementById('historyCard');
  const list=document.getElementById('historyList');
  if(winners.length===0){card.style.display='none';return;}
  card.style.display='block';
  // Group by draw rounds
  let html='',w=0,round=0;
  while(w<winners.length){
    const end=Math.min(w+drawCount,winners.length);
    const batch=winners.slice(w,end);
    round++;
    html+=`<div class="history-item" style="animation-delay:${round*.05}s"><div class="history-round">${round}</div><div>${batch.map(n=>`<span class="history-name">${n}</span>`).join('')}</div></div>`;
    w=end;
  }
  list.innerHTML=html;
}

function showWinners(selected){
  document.getElementById('winnerDisplay').style.display='block';
  document.getElementById('idleMsg').style.display='none';
  document.getElementById('winnerBadges').innerHTML=selected.map(n=>`<div class="winner-badge">${n}</div>`).join('');
}

function updateDrawButton(){
  const btn=document.getElementById('drawBtn');
  const rem=getRemaining();
  if(isDrawing){btn.textContent='â³ æŠ½çä¸­...';btn.disabled=true;}
  else if(rem.length===0){btn.textContent='ğŸ‰ å·²å…¨éƒ¨æŠ½å®Œ';btn.disabled=true;}
  else{btn.textContent='ğŸ² é–‹å§‹æŠ½çï¼';btn.disabled=false;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Import & Navigation
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('nameInput').addEventListener('input',function(){
  const names=this.value.split(/[\n,;]+/).filter(n=>n.trim());
  document.getElementById('participantCount').textContent=names.length+' ä½åƒåŠ è€…';
});

function handleFileUpload(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const names=ev.target.result.split(/[\n,;]+/).map(n=>n.trim()).filter(n=>n.length>0&&!["å§“å","name","Name"].includes(n));
    if(names.length>0){document.getElementById('nameInput').value=names.join('\n');document.getElementById('participantCount').textContent=names.length+' ä½åƒåŠ è€…';}
  };
  reader.readAsText(file);
}

async function startGame(){
  await initSound();
  const text=document.getElementById('nameInput').value;
  const names=text.split(/[\n,;]+/).map(n=>n.trim()).filter(n=>n.length>0);
  if(names.length===0) return;
  participants=names;winners=[];currentWinner=null;phase="idle";
  document.getElementById('importScreen').style.display='none';
  document.getElementById('gameScreen').style.display='block';
  updateStats();renderChips();renderHistory();updateDrawButton();
  document.getElementById('winnerDisplay').style.display='none';
  document.getElementById('idleMsg').style.display='block';
  initBalls(names.length);
  playClick();
}

function goBack(){
  clearAllTimers();stopCrank();
  if(ballFrame){cancelAnimationFrame(ballFrame);ballFrame=null;}
  isDrawing=false;phase="idle";winners=[];currentWinner=null;
  document.getElementById('gameScreen').style.display='none';
  document.getElementById('importScreen').style.display='block';
  document.getElementById('boxCard').classList.remove('box-glow');
  document.getElementById('drumSvg').classList.remove('drum-shake');
}

function updateDrawCount(){drawCount=Math.max(1,parseInt(document.getElementById('drawCountInput').value)||1);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Draw Logic
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tumbleIv=null;
function clearAllTimers(){timers.forEach(clearTimeout);timers=[];if(tumbleIv){clearInterval(tumbleIv);tumbleIv=null;}}

function resetDraw(){
  clearAllTimers();stopCrank();
  isDrawing=false;phase="idle";winners=[];currentWinner=null;
  document.getElementById('winnerDisplay').style.display='none';
  document.getElementById('idleMsg').style.display='block';
  document.getElementById('rollingNameDisplay').style.display='none';
  document.getElementById('ejectedBall').style.display='none';
  document.getElementById('boxCard').classList.remove('box-glow');
  document.getElementById('drumSvg').classList.remove('drum-shake');
  updateStats();renderChips();renderHistory();updateDrawButton();
  initBalls(participants.length);
  playClick();
}

async function draw(){
  const remaining=getRemaining();
  if(remaining.length===0||isDrawing) return;
  await initSound();
  updateDrawCount();
  const count=Math.min(drawCount,remaining.length);
  isDrawing=true;currentWinner=null;
  updateDrawButton();
  document.getElementById('winnerDisplay').style.display='none';
  document.getElementById('idleMsg').style.display='none';
  document.getElementById('ejectedBall').style.display='none';

  // Phase: spinning
  phase="spinning";
  document.getElementById('boxCard').classList.add('box-glow');
  document.getElementById('drumSvg').classList.add('drum-shake');
  document.getElementById('rollingNameDisplay').style.display='block';
  document.getElementById('rollingNameDisplay').classList.add('animate-pulse');
  startCrank();

  // Tumble sound
  tumbleIv=setInterval(()=>playTumble(),200);

  let tickI=0;
  const tickIv=setInterval(()=>{
    const idx=Math.floor(Math.random()*remaining.length);
    document.getElementById('rollingNameDisplay').textContent=remaining[idx];
    if(tickI%3===0) playTick(tickI/45);
    tickI++;
  },70);
  timers.push(tickIv);

  // Slow down after ~2.5s
  const t1=setTimeout(()=>{
    clearInterval(tickIv);
    if(tumbleIv){clearInterval(tumbleIv);tumbleIv=null;}
    phase="slowing";

    let slowI=0,delay=120;
    function slowStep(){
      if(slowI>=8){
        // Eject phase
        phase="eject";
        document.getElementById('drumSvg').classList.remove('drum-shake');
        stopCrank();

        const shuffled=[...remaining].sort(()=>Math.random()-.5);
        const selected=shuffled.slice(0,count);

        // Show ejected ball
        const ballColor=BALL_COLORS[Math.floor(Math.random()*BALL_COLORS.length)];
        const eb=document.getElementById('ejectedBall');
        const ebi=document.getElementById('ejectedBallInner');
        ebi.style.background=`radial-gradient(circle at 35% 35%,#fff 0%,${ballColor} 50%,${ballColor}dd 100%)`;
        ebi.style.boxShadow=`0 4px 20px ${ballColor}88`;
        ebi.textContent=selected.length===1&&selected[0].length<=3?selected[0]:'â˜…';
        eb.style.display='block';
        eb.style.animation='none';eb.offsetHeight;eb.style.animation='ejectBall 1.2s ease-out forwards';
        document.getElementById('rollingNameDisplay').style.display='none';
        playEject();

        const t3=setTimeout(()=>{
          phase="reveal";
          eb.style.display='none';
          winners.push(...selected);currentWinner=selected;
          document.getElementById('boxCard').classList.remove('box-glow');
          showWinners(selected);
          updateStats();renderChips();renderHistory();
          playWin();setTimeout(()=>playCelebration(),400);
          showConfetti();
          // Remove remaining balls
          initBalls(getRemaining().length);

          const t4=setTimeout(()=>{phase="idle";isDrawing=false;updateDrawButton();},3500);
          timers.push(t4);
        },1200);
        timers.push(t3);
        return;
      }
      const idx=Math.floor(Math.random()*remaining.length);
      document.getElementById('rollingNameDisplay').textContent=remaining[idx];
      playSlowTick();
      slowI++;delay+=40+slowI*25;
      const st=setTimeout(slowStep,delay);timers.push(st);
    }
    slowStep();
  },2500);
  timers.push(t1);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Sound Toggle
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function toggleSound(){
  if(!soundReady) await initSound();
  soundOn=!soundOn;
  const btn=document.getElementById('soundBtn');
  btn.textContent=soundOn?'ğŸ”Š':'ğŸ”‡';
  btn.className='btn-sound '+(soundOn?'on':'off');
}
</script>
</body>
</html>
